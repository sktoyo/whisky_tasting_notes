{% extends "base.html" %}

{% block title %}{% if mode == "edit" %}ë…¸íŠ¸ ìˆ˜ì •{% else %}ë…¸íŠ¸ ì‘ì„±{% endif %} - ìœ„ìŠ¤í‚¤ í…Œì´ìŠ¤íŒ… ë…¸íŠ¸{% endblock %}

{% block extra_head %}
<style>
    .keyword-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background: #e5e7eb;
        border-radius: 9999px;
        margin: 0.25rem;
        cursor: pointer;
    }
    .keyword-chip.selected {
        background: #3b82f6;
        color: white;
    }
    .keyword-chip:hover {
        opacity: 0.8;
    }
    .keyword-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        min-height: 100px;
    }
    .detail-input-group {
        margin-top: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<form id="note-form" enctype="multipart/form-data" class="space-y-6">
    <!-- ìƒë‹¨: í˜ì´ì§€ ì œëª© -->
    <div class="form-section">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">{% if mode == "edit" %}ë…¸íŠ¸ ìˆ˜ì •{% else %}ë…¸íŠ¸ ì‘ì„±{% endif %}</h1>
        <p class="text-gray-600">ìœ„ìŠ¤í‚¤ í…Œì´ìŠ¤íŒ… ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</p>
    </div>
    
    <!-- ìœ„ìŠ¤í‚¤ ì •ë³´ ì„¹ì…˜ -->
    <div class="form-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ì¢Œì¸¡: ì •ì‚¬ê°í˜• ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">ëŒ€í‘œ ì´ë¯¸ì§€</label>
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors">
                    <input type="file" id="image-input" name="image" accept="image/*" class="hidden">
                    <div id="image-preview" class="image-upload-square mx-auto mb-4">
                        {% if note and note.image_path %}
                        <img src="/uploads/{{ note.image_path }}" alt="Preview" class="w-full h-full object-cover rounded-lg shadow-md">
                        {% else %}
                        <div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg flex flex-col items-center justify-center">
                            <span class="text-4xl mb-2">ğŸ“·</span>
                            <span class="text-gray-500 text-sm">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" onclick="document.getElementById('image-input').click()" 
                            class="px-6 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors font-medium">
                        ì´ë¯¸ì§€ ì„ íƒ
                    </button>
                </div>
            </div>
            
            <!-- ìš°ì¸¡: ìœ„ìŠ¤í‚¤ ì •ë³´ ì…ë ¥ í¼ -->
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        ìœ„ìŠ¤í‚¤ ì´ë¦„ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="name" value="{% if note %}{{ note.name }}{% endif %}" required
                           placeholder="ì˜ˆ: ë§¥ì¼ˆë€ 18ë…„"
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ì¦ë¥˜ì†Œ</label>
                    <input type="text" name="distillery" value="{% if note %}{{ note.distillery or '' }}{% endif %}"
                           placeholder="ì˜ˆ: ë§¥ì¼ˆë€ ì¦ë¥˜ì†Œ"
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ìˆ™ì„±ë…„ë„</label>
                        <input type="number" name="age" value="{% if note %}{{ note.age or '' }}{% endif %}"
                               placeholder="ì˜ˆ: 18"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ë„ìˆ˜(ABV)</label>
                        <input type="number" step="0.1" name="abv" value="{% if note %}{{ note.abv or '' }}{% endif %}"
                               placeholder="ì˜ˆ: 43.0"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent transition">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ìºìŠ¤í¬ ì¢…ë¥˜</label>
                    <input type="text" name="cask_type" value="{% if note %}{{ note.cask_type or '' }}{% endif %}"
                           placeholder="ì˜ˆ: ì…°ë¦¬ ì˜¤í¬"
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="flex items-center space-x-2 mb-3">
                        <input type="checkbox" name="is_single_cask" {% if note and note.is_single_cask %}checked{% endif %}
                               onchange="toggleCaskInfo(this.checked)" 
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm font-semibold text-gray-700">ì‹±ê¸€ ìºìŠ¤í¬</span>
                    </label>
                    <div id="cask-info" style="display: {% if note and note.is_single_cask %}block{% else %}none{% endif %};">
                        <input type="text" name="cask_info" value="{% if note %}{{ note.cask_info or '' }}{% endif %}"
                               placeholder="ìºìŠ¤í¬ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì”ì—¬ëŸ‰</label>
                        <input type="text" name="bottle_remaining" value="{% if note %}{{ note.bottle_remaining or '' }}{% endif %}"
                               placeholder="ì˜ˆ: 70%"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ê°œë´‰ì¼</label>
                        <input type="date" name="bottle_opened_at" 
                               value="{% if note and note.bottle_opened_at %}{{ note.bottle_opened_at.strftime('%Y-%m-%d') }}{% endif %}"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Nose / Palate / Finish -->
    {% for scope_data in [("nose", "Nose (í–¥)", nose_terms), ("palate", "Palate (ë§›)", palate_terms), ("finish", "Finish (ì—¬ìš´)", finish_terms)] %}
    {% set scope, scope_label, terms = scope_data %}
    <div class="form-section">
        <h2 class="text-2xl font-bold mb-6 text-gray-900 flex items-center">
            <span class="mr-3">{% if scope == "nose" %}ğŸ‘ƒ{% elif scope == "palate" %}ğŸ‘…{% else %}ğŸ’¨{% endif %}</span>
            {{ scope_label }}
        </h2>
        
        <!-- í‚¤ì›Œë“œ ì„ íƒ ì˜ì—­ -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-3">í‚¤ì›Œë“œ ì„ íƒ</label>
            <div class="keyword-list bg-[#fbf3e7] border-2 border-[#f1e0c8] rounded-xl p-4" id="keyword-list-{{ scope }}">
                {% for term in terms %}
                <div class="keyword-chip inline-flex items-center px-4 py-2 bg-[#fff8ee] border border-[#f1e0c8] rounded-full text-sm font-medium text-[#7a5630] hover:border-amber-400 hover:bg-amber-50 cursor-pointer transition-all" 
                     data-scope="{{ scope }}" 
                     data-term="{{ term.term }}" 
                     data-icon="{{ term.icon_key or 'default' }}"
                     data-source-type="{% if term.__class__.__name__ == 'UserTerm' %}user{% else %}vocabulary{% endif %}">
                    <span class="keyword-icon">{{ get_icon_emoji(term.icon_key or 'default') }}</span>
                    <span>{{ term.term }}</span>
                </div>
                {% endfor %}
                <button type="button" onclick="showCustomKeywordModal('{{ scope }}')" 
                        class="keyword-chip inline-flex items-center px-4 py-2 bg-gradient-to-r from-amber-200 to-amber-300 border-2 border-amber-400 text-[#7a5630] rounded-full text-sm font-semibold hover:from-amber-300 hover:to-amber-400 transition-all shadow-sm">
                    <span class="mr-2">+</span>
                    ì»¤ìŠ¤í…€ í‚¤ì›Œë“œ
                </button>
            </div>
        </div>
        
        <!-- ì„ íƒëœ í‚¤ì›Œë“œ í‘œì‹œ (ìˆœì„œ ë³€ê²½/ì‚­ì œë§Œ) -->
        <div id="keyword-details-{{ scope }}" class="space-y-4 mb-6">
            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
        
        <!-- ì„¹ì…˜ë³„ í•œ ì¤„ ì´í‰ -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">{{ scope_label }} í•œ ì¤„ ì´í‰</label>
            <p class="text-xs text-gray-500 mb-3">í‚¤ì›Œë“œì™€ ìƒê´€ì—†ì´ ììœ ë¡­ê²Œ í•œ ì¤„ì”© ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div id="{{ scope }}-lines-container" class="space-y-2 mb-3">
                <!-- JSë¡œ í•œ ì¤„ ì´í‰ input ëª©ë¡ ë Œë”ë§ -->
            </div>
            <button type="button" onclick="addSectionLine('{{ scope }}')" class="px-3 py-1.5 text-xs rounded-full border border-amber-400 text-[#7a5630] bg-amber-50 hover:bg-amber-100 transition">
                + í•œ ì¤„ ì¶”ê°€
            </button>
            <!-- ì‹¤ì œ ì „ì†¡ìš© hidden textarea -->
            <textarea id="{{ scope }}_comment" name="{{ scope }}_comment" class="hidden">{% if note %}{% if scope == 'nose' %}{{ note.nose_comment or '' }}{% elif scope == 'palate' %}{{ note.palate_comment or '' }}{% else %}{{ note.finish_comment or '' }}{% endif %}{% endif %}</textarea>
        </div>
    </div>
    {% endfor %}
    
    <!-- ì´í‰ ë° ì ìˆ˜ -->
    <div class="form-section">
        <h2 class="text-2xl font-bold mb-6 text-gray-900">ì´í‰ ë° ì ìˆ˜</h2>
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">í•œ ì¤„ ì´í‰</label>
            <p class="text-xs text-gray-500 mb-3">í‚¤ì›Œë“œì™€ ìƒê´€ì—†ì´ ììœ ë¡­ê²Œ í•œ ì¤„ì”© ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div id="overall-lines-container" class="space-y-2 mb-3">
                <!-- JSë¡œ í•œ ì¤„ ì´í‰ input ëª©ë¡ ë Œë”ë§ -->
            </div>
            <button type="button" onclick="addOverallLine()" class="px-3 py-1.5 text-xs rounded-full border border-amber-400 text-[#7a5630] bg-amber-50 hover:bg-amber-100 transition">
                + í•œ ì¤„ ì¶”ê°€
            </button>
            <!-- ì‹¤ì œ ì „ì†¡ìš© hidden textarea -->
            <textarea id="overall_comment" name="overall_comment" class="hidden">{% if note %}{{ note.overall_comment or '' }}{% endif %}</textarea>
        </div>
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">ì ìˆ˜ (0-100, ì„ íƒ)</label>
            <div class="flex items-center space-x-4">
                <input type="number" name="score" min="0" max="100" value="{% if note %}{{ note.score or '' }}{% endif %}"
                       placeholder="0-100"
                       class="w-32 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent transition">
                <span class="text-gray-500 text-sm">ì </span>
            </div>
        </div>
    </div>
    
    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="form-section bg-gray-50">
        <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" name="is_draft" {% if note and note.is_draft %}checked{% endif %} 
                       class="w-4 h-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500">
                <span class="text-sm font-medium text-gray-700">ì„ì‹œ ì €ì¥ (Draft)</span>
            </label>
            <div class="flex gap-3">
                <button type="button" onclick="previewNote()" 
                        class="px-6 py-2.5 bg-[#e5e1dd] hover:bg-[#d6d0c8] text-gray-700 rounded-lg transition-colors font-medium">
                    ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button type="submit" 
                        class="px-8 py-2.5 bg-gradient-to-r from-amber-700 to-amber-800 text-white rounded-lg hover:from-amber-800 hover:to-amber-900 transition-all duration-200 shadow-md hover:shadow-lg font-semibold">
                    {% if mode == "edit" %}ìˆ˜ì • ì™„ë£Œ{% else %}ì œì¶œ{% endif %}
                </button>
            </div>
        </div>
    </div>
</form>

<!-- ì»¤ìŠ¤í…€ í‚¤ì›Œë“œ ëª¨ë‹¬ -->
<div id="custom-keyword-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 class="text-xl font-bold mb-4">ì»¤ìŠ¤í…€ í‚¤ì›Œë“œ ì¶”ê°€</h3>
        <input type="text" id="custom-keyword-input" placeholder="í‚¤ì›Œë“œ ì…ë ¥" class="w-full px-3 py-2 border rounded mb-4">
        <div class="flex gap-2 justify-end">
            <button onclick="closeCustomKeywordModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
            <button onclick="addCustomKeyword()" class="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700">ì¶”ê°€</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ì „ì—­ ìƒíƒœ
const selectedKeywords = {
    nose: {% if mode == "edit" and nose_keywords %}{{ nose_keywords | tojson }}{% else %}[]{% endif %},
    palate: {% if mode == "edit" and palate_keywords %}{{ palate_keywords | tojson }}{% else %}[]{% endif %},
    finish: {% if mode == "edit" and finish_keywords %}{{ finish_keywords | tojson }}{% else %}[]{% endif %}
};
let currentCustomScope = null;
let overallLines = [];
const sectionLines = {
    nose: [],
    palate: [],
    finish: []
};

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
document.getElementById('image-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('image-preview').innerHTML = 
                `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover rounded-lg shadow-md">`;
        };
        reader.readAsDataURL(file);
    }
});

// ì´í‰ í•œ ì¤„ ê´€ë¦¬
function renderOverallLines() {
    const container = document.getElementById('overall-lines-container');
    if (!container) return;

    // ì´ˆê¸°í™”
    container.innerHTML = '';

    overallLines.forEach((line, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent text-sm';
        input.placeholder = 'í•œ ì¤„ í‰ì„ ì…ë ¥í•˜ì„¸ìš”...';
        input.value = line;
        input.addEventListener('change', function () {
            updateOverallLine(idx, this.value);
        });

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'px-2 py-1 text-xs text-gray-500 hover:text-red-500';
        btn.textContent = 'ì‚­ì œ';
        btn.addEventListener('click', function () {
            removeOverallLine(idx);
        });

        row.appendChild(input);
        row.appendChild(btn);
        container.appendChild(row);
    });

    // hidden textarea ì—…ë°ì´íŠ¸
    const hidden = document.getElementById('overall_comment');
    if (hidden) {
        hidden.value = overallLines.join('\n');
    }
}

function addOverallLine(initial) {
    const value = typeof initial === 'string' ? initial : '';
    overallLines.push(value);
    renderOverallLines();
}

function removeOverallLine(index) {
    overallLines.splice(index, 1);
    renderOverallLines();
}

function updateOverallLine(index, value) {
    overallLines[index] = value;
    // hidden textareaë§Œ ê°±ì‹ 
    const hidden = document.getElementById('overall_comment');
    if (hidden) {
        hidden.value = overallLines.join('\n');
    }
}

// ì„¹ì…˜ë³„ í•œ ì¤„ ì´í‰ ê´€ë¦¬
function renderSectionLines(scope) {
    const container = document.getElementById(`${scope}-lines-container`);
    if (!container) return;

    // ì´ˆê¸°í™”
    container.innerHTML = '';

    sectionLines[scope].forEach((line, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent text-sm';
        input.placeholder = 'í•œ ì¤„ í‰ì„ ì…ë ¥í•˜ì„¸ìš”...';
        input.value = line;
        input.addEventListener('change', function () {
            updateSectionLine(scope, idx, this.value);
        });

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'px-2 py-1 text-xs text-gray-500 hover:text-red-500';
        btn.textContent = 'ì‚­ì œ';
        btn.addEventListener('click', function () {
            removeSectionLine(scope, idx);
        });

        row.appendChild(input);
        row.appendChild(btn);
        container.appendChild(row);
    });

    // hidden textarea ì—…ë°ì´íŠ¸
    const hidden = document.getElementById(`${scope}_comment`);
    if (hidden) {
        hidden.value = sectionLines[scope].join('\n');
    }
}

function addSectionLine(scope, initial) {
    const value = typeof initial === 'string' ? initial : '';
    sectionLines[scope].push(value);
    renderSectionLines(scope);
}

function removeSectionLine(scope, index) {
    sectionLines[scope].splice(index, 1);
    renderSectionLines(scope);
}

function updateSectionLine(scope, index, value) {
    sectionLines[scope][index] = value;
    // hidden textareaë§Œ ê°±ì‹ 
    const hidden = document.getElementById(`${scope}_comment`);
    if (hidden) {
        hidden.value = sectionLines[scope].join('\n');
    }
}

// í‚¤ì›Œë“œ ì„ íƒ í† ê¸€ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
function setupKeywordClickHandlers() {
    ['nose', 'palate', 'finish'].forEach(scope => {
        const keywordList = document.getElementById(`keyword-list-${scope}`);
        if (keywordList) {
            keywordList.addEventListener('click', function(e) {
                const chip = e.target.closest('.keyword-chip');
                if (!chip || chip.tagName === 'BUTTON') return; // ë²„íŠ¼ì´ë©´ ë¬´ì‹œ
                
                const chipScope = chip.dataset.scope;
                const term = chip.dataset.term;
                const icon = chip.dataset.icon || 'default';
                const sourceType = chip.dataset.sourceType || 'vocabulary';
                
                if (!chipScope || !term) return; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
                
                // ì´ë¯¸ ì„ íƒëœ í‚¤ì›Œë“œë©´ ì œê±°
                if (selectedKeywords[chipScope] && selectedKeywords[chipScope].some(k => k.term === term)) {
                    const index = selectedKeywords[chipScope].findIndex(k => k.term === term);
                    removeKeyword(chipScope, index);
                } else {
                    selectKeyword(chipScope, term, icon, sourceType);
                }
            });
        }
    });
}

function selectKeyword(scope, term, icon, sourceType = 'vocabulary') {
    if (!selectedKeywords[scope]) {
        selectedKeywords[scope] = [];
    }
    
    // ì¤‘ë³µ ì²´í¬
    if (selectedKeywords[scope].some(k => k.term === term)) {
        return;
    }
    
    selectedKeywords[scope].push({
        term: term,
        icon_key: icon,
        detail_text: '', // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
        position: selectedKeywords[scope].length,
        source_type: sourceType
    });
    
    updateKeywordUI(scope);
}

function removeKeyword(scope, index) {
    selectedKeywords[scope].splice(index, 1);
    // position ì¬ì •ë ¬
    selectedKeywords[scope].forEach((kw, idx) => {
        kw.position = idx;
    });
    updateKeywordUI(scope);
}

function moveKeyword(scope, index, direction) {
    if (direction === 'up' && index > 0) {
        [selectedKeywords[scope][index], selectedKeywords[scope][index - 1]] = 
            [selectedKeywords[scope][index - 1], selectedKeywords[scope][index]];
        selectedKeywords[scope].forEach((kw, idx) => {
            kw.position = idx;
        });
        updateKeywordUI(scope);
    } else if (direction === 'down' && index < selectedKeywords[scope].length - 1) {
        [selectedKeywords[scope][index], selectedKeywords[scope][index + 1]] = 
            [selectedKeywords[scope][index + 1], selectedKeywords[scope][index]];
        selectedKeywords[scope].forEach((kw, idx) => {
            kw.position = idx;
        });
        updateKeywordUI(scope);
    }
}

// Icon mapping (same as backend)
function getIconEmoji(iconKey) {
    const iconMap = {
        "vanilla": "ğŸŒ¿", "oak": "ğŸªµ", "fruit": "ğŸ", "flower": "ğŸŒ¸", "herb": "ğŸŒ¿",
        "spice": "ğŸŒ¶ï¸", "honey": "ğŸ¯", "chocolate": "ğŸ«", "coffee": "â˜•", "citrus": "ğŸ‹",
        "peat": "ğŸ”¥", "sea": "ğŸŒŠ", "earth": "ğŸŒ", "tobacco": "ğŸš¬", "nut": "ğŸ¥œ",
        "caramel": "ğŸ®", "dried_fruit": "ğŸ‡", "wood": "ğŸªµ", "sweet": "ğŸ¬", "bitter": "â˜•",
        "sour": "ğŸ‹", "salty": "ğŸ§‚", "smooth": "âœ¨", "intense": "ğŸ’¥", "long": "â±ï¸",
        "short": "âš¡", "warm": "ğŸ”¥", "cool": "â„ï¸", "custom": "ğŸ·ï¸", "default": "ğŸ”–"
    };
    return iconMap[iconKey] || "ğŸ”–";
}

function updateKeywordUI(scope) {
    // ì„ íƒëœ í‚¤ì›Œë“œ ì¹© í‘œì‹œ
    document.querySelectorAll(`[data-scope="${scope}"].keyword-chip`).forEach(chip => {
        const term = chip.dataset.term;
        const isSelected = selectedKeywords[scope].some(k => k.term === term);
        if (isSelected) {
            chip.classList.add('selected');
            chip.style.backgroundColor = '#f59e0b';
            chip.style.color = '#fff';
            chip.style.borderColor = '#f59e0b';
            chip.style.cursor = 'default';
        } else {
            chip.classList.remove('selected');
            chip.style.backgroundColor = '#fff8ee';
            chip.style.color = '#7a5630';
            chip.style.borderColor = '#f1e0c8';
            chip.style.cursor = 'pointer';
        }
    });
    
    // ì„ íƒëœ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ (ìˆœì„œ ë³€ê²½/ì‚­ì œë§Œ)
    const detailsContainer = document.getElementById(`keyword-details-${scope}`);
    if (selectedKeywords[scope].length === 0) {
        detailsContainer.innerHTML = '';
        return;
    }
    
    detailsContainer.innerHTML = `
        <div class="bg-gray-50 rounded-lg p-4">
            <label class="block text-sm font-semibold text-gray-700 mb-3">ì„ íƒëœ í‚¤ì›Œë“œ</label>
            <div class="space-y-2">
                ${selectedKeywords[scope].map((kw, index) => `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${getIconEmoji(kw.icon_key || 'default')}</span>
                            <span class="font-medium text-gray-900">${kw.term}</span>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="moveKeyword('${scope}', ${index}, 'up')" 
                                    class="px-2 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded transition-colors" 
                                    ${index === 0 ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>â–²</button>
                            <button type="button" onclick="moveKeyword('${scope}', ${index}, 'down')" 
                                    class="px-2 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded transition-colors" 
                                    ${index === selectedKeywords[scope].length - 1 ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>â–¼</button>
                            <button type="button" onclick="removeKeyword('${scope}', ${index})" 
                                    class="px-2 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors">ì‚­ì œ</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function showCustomKeywordModal(scope) {
    currentCustomScope = scope;
    document.getElementById('custom-keyword-modal').classList.remove('hidden');
    document.getElementById('custom-keyword-input').value = '';
    document.getElementById('custom-keyword-input').focus();
}

function closeCustomKeywordModal() {
    document.getElementById('custom-keyword-modal').classList.add('hidden');
    currentCustomScope = null;
}

async function addCustomKeyword() {
    const term = document.getElementById('custom-keyword-input').value.trim();
    if (!term || !currentCustomScope) {
        return;
    }
    
    // API í˜¸ì¶œí•˜ì—¬ ì»¤ìŠ¤í…€ í‚¤ì›Œë“œ ìƒì„±
    const formData = new FormData();
    formData.append('scope', currentCustomScope);
    formData.append('term', term);
    formData.append('icon_key', 'custom');
    
    try {
        const response = await fetch('/api/keywords/custom', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        // í‚¤ì›Œë“œ ëª©ë¡ì— ì¶”ê°€
        const keywordList = document.getElementById(`keyword-list-${currentCustomScope}`);
        const newChip = document.createElement('div');
        newChip.className = 'keyword-chip inline-flex items-center px-4 py-2 bg-[#fff8ee] border border-[#f1e0c8] rounded-full text-sm font-medium text-[#7a5630] hover:border-amber-400 hover:bg-amber-50 cursor-pointer transition-all';
        newChip.dataset.scope = currentCustomScope;
        newChip.dataset.term = term;
        newChip.dataset.icon = 'custom';
        newChip.dataset.sourceType = 'user';
        newChip.innerHTML = `<span class="keyword-icon">${getIconEmoji('custom')}</span><span>${term}</span>`;
        
        // + ë²„íŠ¼ ì•ì— ì‚½ì…
        const addButton = keywordList.querySelector('button');
        keywordList.insertBefore(newChip, addButton);
        
        // ì¦‰ì‹œ ì„ íƒ (ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ í´ë¦­ ì´ë²¤íŠ¸ê°€ ìë™ ì²˜ë¦¬ë¨)
        selectKeyword(currentCustomScope, term, 'custom', 'user');
        
        closeCustomKeywordModal();
    } catch (error) {
        alert('ì»¤ìŠ¤í…€ í‚¤ì›Œë“œ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
    }
}

function toggleCaskInfo(show) {
    document.getElementById('cask-info').style.display = show ? 'block' : 'none';
}

function previewNote() {
    // ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ (ê°„ë‹¨í•œ alertë¡œ ëŒ€ì²´)
    alert('ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì€ ìƒì„¸ í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
}

// í¼ ì œì¶œ
document.getElementById('note-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // ì´í‰ í•œ ì¤„ë“¤ì„ hidden textareaì— ë°˜ì˜
    const hiddenOverall = document.getElementById('overall_comment');
    if (hiddenOverall) {
        hiddenOverall.value = overallLines.join('\n');
    }
    
    // ì„¹ì…˜ë³„ í•œ ì¤„ ì´í‰ì„ hidden textareaì— ë°˜ì˜
    ['nose', 'palate', 'finish'].forEach(scope => {
        const hidden = document.getElementById(`${scope}_comment`);
        if (hidden) {
            hidden.value = sectionLines[scope].join('\n');
        }
    });

    const formData = new FormData(this);
    
    // í‚¤ì›Œë“œ ë°ì´í„° ì¶”ê°€
    const keywords = [];
    ['nose', 'palate', 'finish'].forEach(scope => {
        selectedKeywords[scope].forEach(kw => {
            keywords.push({
                scope: scope,
                term: kw.term,
                icon_key: kw.icon_key,
                detail_text: '', // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ë¹ˆ ë¬¸ìì—´
                position: kw.position,
                source_type: kw.source_type
            });
        });
    });
    formData.append('keywords_json', JSON.stringify(keywords));
    
    const url = {% if mode == "edit" %}'/api/notes/{{ note.id }}'{% else %}'/api/notes'{% endif %};
    const method = {% if mode == "edit" %}'PUT'{% else %}'POST'{% endif %};
    
    try {
        const response = await fetch(url, {
            method: method,
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            window.location.href = `/notes/${data.id}`;
        } else {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (await response.text()));
        }
    } catch (error) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
    }
});

// ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ì¡´ í‚¤ì›Œë“œ í‘œì‹œ
['nose', 'palate', 'finish'].forEach(scope => {
    if (selectedKeywords[scope] && selectedKeywords[scope].length > 0) {
        // position ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        selectedKeywords[scope].sort((a, b) => (a.position || 0) - (b.position || 0));
        updateKeywordUI(scope);
    }
});

// ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ì¡´ ì´í‰ì„ í•œ ì¤„ì”© ë¶„í•´
window.addEventListener('DOMContentLoaded', () => {
    // í‚¤ì›Œë“œ í´ë¦­ í•¸ë“¤ëŸ¬ ì„¤ì •
    setupKeywordClickHandlers();
    
    // ì „ì²´ ì´í‰
    const hidden = document.getElementById('overall_comment');
    if (hidden && hidden.value.trim() !== '') {
        overallLines = hidden.value.split(/\r?\n/).map(l => l.trim());
    } else {
        overallLines = [''];
    }
    renderOverallLines();
    
    // ì„¹ì…˜ë³„ ì´í‰
    ['nose', 'palate', 'finish'].forEach(scope => {
        const sectionHidden = document.getElementById(`${scope}_comment`);
        if (sectionHidden && sectionHidden.value.trim() !== '') {
            sectionLines[scope] = sectionHidden.value.split(/\r?\n/).map(l => l.trim());
        } else {
            sectionLines[scope] = [''];
        }
        renderSectionLines(scope);
    });
});
</script>
{% endblock %}

